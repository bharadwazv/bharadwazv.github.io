<!DOCTYPE html>
<html>
<head>
    <title>ESP32 LED Control</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>
    <style>
        body { font-family: sans-serif; text-align: center; margin-top: 50px; background-color: #f4f4f4; }
        .container { background-color: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: inline-block; }
        button { font-size: 24px; padding: 15px 30px; cursor: pointer; border-radius: 5px; border: none; background-color: #007bff; color: white; }
        #status-display { font-size: 20px; margin-top: 20px; }
        #light-status { font-weight: bold; padding: 5px 10px; border-radius: 5px; }
        .status-on { background-color: #28a745; color: white; }
        .status-off { background-color: #dc3545; color: white; }
        .status-unknown { background-color: #6c757d; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ESP32 Remote LED</h1>
        <button onclick="toggleLed()">Toggle LED</button>
        <div id="status-display">
            Light Status: <span id="light-status" class="status-unknown">Unknown</span>
        </div>
        <p id="connection-status" style="color: grey;">Connecting...</p>
    </div>

    <script>
        // --- Use the same unique name as your ESP32 sketch ---
        const unique_name = "pandav_abhi";
        const commandTopic = `esp32/${unique_name}/led/control`;
        const statusTopic = `esp32/${unique_name}/led/status`;

        // --- Broker Details ---
        const brokerHost = "broker.hivemq.com";
        const brokerPort = 8884; // Secure port
        
        const clientId = "web-client-" + Math.random().toString(16).substr(2, 8);
        const client = new Paho.MQTT.Client(brokerHost, brokerPort, clientId);

        client.onConnectionLost = onConnectionLost;
        client.onMessageArrived = onMessageArrived;
        
        // Connect the client, enabling SSL for a secure connection
        client.connect({ onSuccess: onConnect, useSSL: true });

        const statusElement = document.getElementById('light-status');
        const connectionStatusElement = document.getElementById('connection-status');

        function onConnect() {
            console.log("Connected to MQTT broker via WSS");
            connectionStatusElement.textContent = "Connected!";
            // Subscribe to the status topic
            client.subscribe(statusTopic);
            console.log("Subscribed to: " + statusTopic);
        }

        function onConnectionLost(responseObject) {
            if (responseObject.errorCode !== 0) {
                console.log("onConnectionLost:" + responseObject.errorMessage);
                connectionStatusElement.textContent = "Connection lost. Please refresh.";
            }
        }

        // This function now handles incoming status messages
        function onMessageArrived(message) {
            console.log("Message Arrived: " + message.payloadString);
            if (message.destinationName === statusTopic) {
                updateStatus(message.payloadString);
            }
        }

        function updateStatus(status) {
            statusElement.textContent = status;
            statusElement.className = ''; // Clear existing classes
            if (status === "ON") {
                statusElement.classList.add('status-on');
            } else if (status === "OFF") {
                statusElement.classList.add('status-off');
            } else {
                statusElement.classList.add('status-unknown');
            }
        }

        // Function to publish the "TOGGLE" command
        function toggleLed() {
            if (!client.isConnected()) {
                alert("Not connected to the broker yet!");
                return;
            }
            const message = new Paho.MQTT.Message("TOGGLE");
            message.destinationName = commandTopic;
            client.send(message);
            console.log("Sent 'TOGGLE' message to topic: " + commandTopic);
        }
    </script>
</body>
</html>
